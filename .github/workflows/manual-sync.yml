name: Manual Astro Sync

on:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: manual-sync
  cancel-in-progress: true

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    env:
      ROOT: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Bubble → Files sync (prebuilt HTML)
        env:
          BUBBLE_BASE_URL: ${{ secrets.BUBBLE_BASE_URL }}
        run: |
          # default if secret is missing
          : "${BUBBLE_BASE_URL:=https://stackable.club/version-test/api/1.1/obj}"
          pnpm --filter scripts run build:sync
          pnpm --filter scripts run sync

      - name: Ensure public/ exists (Astro fallback)
        run: |
          if [ ! -f "projects/study-in--japan/public/index.html" ]; then
            echo "public/ missing — building 'study-in--japan' and mirroring dist → public"
            pnpm --filter "study-in--japan" run build
            rsync -a --delete projects/study-in--japan/dist/ projects/study-in--japan/public/
          fi

      - name: Verify generated files
        run: |
          COUNT=$(find projects/study-in--japan/public -type f | wc -l | tr -d ' ')
          echo "File count in public/: $COUNT"
          find projects/study-in--japan/public -type f | head -n 30
          if [ "$COUNT" -le 0 ]; then
            echo "No files to deploy"; exit 1
          fi

      - name: Zip public/
        run: |
          cd projects/study-in--japan/public
          zip -qr "${ROOT}/site.zip" .

      - name: Deploy ZIP to Netlify (production)
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID_JAPAN: ${{ secrets.NETLIFY_SITE_ID_JAPAN }}
        run: |
          if [ -z "$NETLIFY_AUTH_TOKEN" ] || [ -z "$NETLIFY_SITE_ID_JAPAN" ]; then
            echo "Missing NETLIFY_AUTH_TOKEN or NETLIFY_SITE_ID_JAPAN"; exit 1
          fi
          RESP=$(curl -sS -X POST \
            -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" \
            -H "Content-Type: application/zip" \
            --data-binary "@${ROOT}/site.zip" \
            "https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID_JAPAN}/deploys")
          echo "$RESP"
